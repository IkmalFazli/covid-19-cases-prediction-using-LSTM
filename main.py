# -*- coding: utf-8 -*-
"""Untitled4.ipynb

Automatically generated by Colaboratory.

Original file is located at
    https://colab.research.google.com/drive/179Oti31X_MRoaRX332gYpDRM63cOeW1y
"""

# Commented out IPython magic to ensure Python compatibility.
# %cd /content/drive/MyDrive/Colab Notebooks

from Module.covid_prediction_module import EDA,ModelCreation,model_evaluation
from sklearn.metrics import mean_squared_error,mean_absolute_error
from sklearn.metrics import mean_absolute_percentage_error
from tensorflow.keras.callbacks import TensorBoard
from sklearn.preprocessing import MinMaxScaler
from tensorflow.keras.utils import plot_model
import matplotlib.pyplot as plt
import pandas as pd
import numpy as np
import datetime
import pickle
import os

# static

DATA_PATH = os.path.join(os.getcwd(),'Dataset','cases_malaysia_train.csv')
TESTING_PATH = os.path.join(os.getcwd(),'Dataset','cases_malaysia_test.csv')
OPEN_MMS_PATH = os.path.join(os.getcwd(),'mms.pkl')
log_dir = datetime.datetime.now().strftime("%Y%m%d-%H%M%S")
LOG_FOLDER_PATH = os.path.join(os.getcwd(),'Covid_logs', log_dir)

"""# Step 1) Data Loading"""

df = pd.read_csv(DATA_PATH,na_values=[' ','?'])
df_test = pd.read_csv(TESTING_PATH)

target_column = ['cases_new']

"""# Step 2) Data Inspection"""

df.info()
df.describe().T

eda = EDA()
eda.plot_graph(df,target_column)

print('number of null column ' + str(df[target_column].isna().sum()))

print('number of duplicated ' + str(df.duplicated().sum()))

"""# Step 3) Data Cleaning
- No duplicated data
- deal with 12 null values
"""

df[target_column] = df[target_column].interpolate()
df=pd.DataFrame(df)

df.info()

"""# Step 4) Feature Selection
- we selecting 'cases_new' column

# Step 5) Preprocessing
"""
mms = MinMaxScaler()
df = mms.fit_transform(np.expand_dims(df['cases_new'],axis=-1))

with open(OPEN_MMS_PATH,'wb') as file:
  pickle.dump(mms,file)

X_train = [] 
y_train = []

win_size = 30

for i in range(win_size,np.shape(df)[0]): 
  X_train.append(df[i-win_size:i,0]) 
  y_train.append(df[i,0]) 

X_train = np.array(X_train)
y_train = np.array(y_train)

md = ModelCreation()
model = md.simple_lstm_layer(X_train)

model.compile(optimizer='adam',loss='mse',metrics='mape')

plot_model(model,to_file='model_plot.png',show_shapes=True,show_layer_names=True)

# Callbacks
tensorboard_callback = TensorBoard(log_dir=LOG_FOLDER_PATH)

hist = model.fit(X_train,y_train,
                 epochs=100, batch_size=32, callbacks=[tensorboard_callback])

hist.history.keys()

plt.figure()
plt.plot(hist.history['mape'])
plt.show()

plt.figure()
plt.plot(hist.history['loss'])
plt.show()

#%% Model deployment and analysis
test_df = pd.read_csv(TESTING_PATH,na_values=[' '])
test_df.info()

test_df = test_df['cases_new'].interpolate()
test_df= pd.DataFrame(test_df)

test_df = mms.transform(np.expand_dims(test_df['cases_new'],axis=-1))

con_test = np.concatenate((df,test_df),axis=0)
con_test = con_test[-(win_size+len(test_df)):]

X_test = []
for i in range(win_size,len(con_test)):  #60,80
  X_test.append(con_test[i-win_size:i,0])

#OR
#X_test = [con_test[i-win_size:i,0] for i in range(win_size,len(con_test))] 

X_test = np.array(X_test)

predicted = model.predict(np.expand_dims(X_test,axis=-1))

#%% plotting of graphs
me = model_evaluation()
me.plot_predicted_graph(test_df,predicted,mms)

#%% MSE, MAPE
print('mae:',mean_absolute_error(test_df,predicted))
print('mse:',mean_squared_error(test_df,predicted))
print('mape:',mean_absolute_percentage_error(test_df,predicted))

test_df_inversed = mms.inverse_transform(test_df)
predicted_inversed = mms.inverse_transform(predicted)

print('mae_inversed:',mean_absolute_error(test_df_inversed,predicted_inversed))
print('mse_inversed:',mean_squared_error(test_df_inversed,predicted_inversed))
print('mape_inversed:',mean_absolute_percentage_error(test_df_inversed,
                                                      predicted_inversed))

# Discussion

#This model can predict the trend of the covid 19 cases
#Despite error is around mean absolute error of 7% and error is only
#around 14% for MAPE when tested against testing dataset.

from sklearn.metrics import mean_absolute_error

y_true = mms.inverse_transform(test_df)
y_pred = mms.inverse_transform(predicted)

print((mean_absolute_error(y_true, y_pred)/sum(abs(y_true))) *100)

# Commented out IPython magic to ensure Python compatibility.
# %load_ext tensorboard
# %tensorboard --logdir Covid_logs